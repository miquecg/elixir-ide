---
- hosts: localhost
  connection: local
  vars_files:
    - vars/registry.yml
  vars:
    release_date: "{{ '%Y.%m.01' | strftime }}"
    base_url: https://archive.archlinux.org/iso/{{ release_date }}
    files:
      tarball: archlinux-bootstrap-{{ release_date }}-x86_64.tar.gz
      checksum: sha1sums.txt
    image:
      name: "{{ registry.name }}/{{ registry.repo }}"
      tag: "{{ release_date }}"
  tasks:
    - name: Download Arch Linux bootstrap tarball
      get_url:
        url: "{{ base_url }}/{{ files.tarball }}"
        dest: ./archlinux-bootstrap.tar.gz
        checksum: sha1:{{ base_url }}/{{ files.checksum }}
    - name: Create an empty container
      command: buildah from scratch
      register: buildah_from
    - name: Mount container's root filesystem
      command: buildah mount {{ buildah_from.stdout }}
      register: buildah_mount
    - name: Extract bootstrap tarball to mount point
      unarchive:
        src: ./archlinux-bootstrap.tar.gz
        dest: "{{ buildah_mount.stdout }}"
        extra_opts: [--strip-components=1]
    - name: Login to registry
      command: buildah login -u {{ registry.user }} --password-stdin {{ registry.name }}
      args:
        stdin: "{{ registry.password }}"
    - name: Commit changes in container to an image on the registry
      command: buildah commit {{ buildah_from.stdout }} docker://{{ image.name }}:{{ image.tag }}
