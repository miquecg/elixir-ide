---
- name: Release {{ release.current }}
  include_tasks: download-tarball.yml
  vars:
    date: "{{ release.current }}"
  args:
    apply:
      ignore_errors: yes
- name: Fallback to release {{ release.previous }}
  include_tasks: download-tarball.yml
  vars:
    date: "{{ release.previous }}"
  when: tarball_result is failed
- name: Create an empty container
  command: buildah from scratch
  register: buildah_from
- name: "{{ buildah_from.stdout }} created"
  set_fact:
    working_container: "{{ buildah_from.stdout }}"
- name: Mount {{ working_container }}
  command: buildah mount {{ working_container }}
  register: buildah_mount
- name: Create root filesystem
  unarchive:
    src: "{{ path_to_bootstrap }}"
    dest: "{{ buildah_mount.stdout }}"
    extra_opts: [--strip-components=1]
- name: Ensure pacman has a mirror configured
  lineinfile:
    path: "{{ buildah_mount.stdout }}/etc/pacman.d/mirrorlist"
    regexp: "{{ pacman_mirror }}"
    line: "Server = {{ pacman_mirror }}/$repo/os/$arch"
- name: Copy pacman.conf
  copy:
    src: pacman.conf
    dest: "{{ buildah_mount.stdout }}/etc/pacman.conf"
    owner: root
    group: root
    mode: '0644'
